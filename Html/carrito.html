<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/carrito_styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Lemon&display=swap" rel="stylesheet">
    <title>Carrito de Presupuesto</title>
</head>
<body>
    <header>
        <div id="productSuggestion" class="popup" style="display: none;">
    <div class="popup-content">
        <span class="close" onclick="closePopup()">&times;</span>
        <div class="logo-popup">
            <img src="/public/img/logoECDA.png" alt="Logo">
        </div>
        <p>¿Quieres cambiar a este producto?</p>
        <button id="yesBtn">Sí</button>
        <button id="noBtn" onclick="closePopup()">No</button>
    </div>
</div>
        <section class="barra-superior">
            <div class="logo">
                <img src="../img/logoECDA.png" alt="Logo">
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Buscar...">
                <button onclick="realizarBusqueda()">
                    <img src="../img/buscar.png" alt="Buscar">
                </button>
            </div>
            <div class="icons">
                <a href="../html/categorias.php">
                    <img src="../img/categorias.png" alt="Categorias">
                </a>
                <a href="../html/Carrito.html">
                    <img src="../img/carrito-de-compras.png" alt="Carrito de Compras">
                </a>
                <a href="../html/selec_tienda.php">
                    <img src="../img/tienda.png" alt="Tienda">
                </a>
                <a href="../html/login.html">
                    <img src="../img/iniciar-sesion.png" alt="Iniciar Sesión">
                </a>    
            </div>
        </section>
    </header>   

    <main>
        <div class="tienda-container">
            <div class="nombre-tienda">
                <img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/Logo_Jumbo_Cencosud.png" alt="Jumbo" class="icono-tienda">
                <h2>Jumbo</h2>
            </div>
            <div class="productos-container" id="productos-container-jumbo">
                <!-- Los productos de Jumbo se cargarán aquí -->
            </div>
        </div>

        <div class="tienda-container">
            <div class="nombre-tienda">
                <img src="https://upload.wikimedia.org/wikipedia/commons/1/1c/Unimarc_logo.svg" alt="Unimarc" class="icono-tienda">
                <h2>Unimarc</h2>
            </div>
            <div class="productos-container" id="productos-container-unimarc">
                <!-- Los productos de Unimarc se cargarán aquí -->
            </div>
        </div>

        <h2 class="carrito-titulo">Carrito</h2>
        <ul id="cart-items"></ul>
        <p>Total: $<span id="total">0</span></p>
    </main>

    <footer>
        <img src="../img/logoECDA.png" alt="Logo">
        <p>© 2024 Cacique del Ahorro. Todos los derechos reservados.</p>
        <a href="../index.html" class="inicio-btn">Ir a Inicio</a>
    </footer>

    <script src="../js/carrito.js"></script> <!-- Asegúrate de que esta ruta es correcta -->
    <script>
        const carrito = {}; // Objeto para almacenar productos y sus cantidades
    
        // Cambia las URL a las correctas para tu entorno
        fetch('/jumbo') // Cambia esta URL
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const jumboContainer = document.getElementById('productos-container-jumbo');
                jumboContainer.innerHTML = ''; // Limpiar el contenedor antes de agregar productos
    
                data.forEach(oferta => {
                    const ofertaDiv = document.createElement('div');
                    ofertaDiv.classList.add('producto');
                    ofertaDiv.innerHTML = `
                        <div class="image-container">
                            <img src="${oferta.imagen_producto}" alt="${oferta.Nombre_producto}">
                            <div class="precio-oferta" data-precio="${oferta.Costo}">$${oferta.Costo}</div>
                        </div>
                        <p>${oferta.Descripcion_Producto}</p>
                        <a href="${oferta.link_producto}" class="category-btn">Ir a la Oferta</a>
                        <button class="agregar-carrito">Agregar al Carrito</button>
                        <button class="buscar-alternativa" data-nombre="${oferta.Nombre_producto}">Buscar Alternativa</button>
                    `;
                    jumboContainer.appendChild(ofertaDiv);
                });
    
                // Manejar el evento de agregar al carrito
                manejarEventosAgregarCarrito(jumboContainer);
                manejarEventosBuscarAlternativa(jumboContainer);
            })
            .catch(error => console.error('Error en la carga de jumbo:', error));
    
        fetch('/unimarc') // Cambia esta URL
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const unimarcContainer = document.getElementById('productos-container-unimarc');
                unimarcContainer.innerHTML = ''; // Limpiar el contenedor antes de agregar productos
    
                data.forEach(oferta => {
                    const ofertaDiv = document.createElement('div');
                    ofertaDiv.classList.add('producto');
                    ofertaDiv.innerHTML = `
                        <div class="image-container">
                            <img src="${oferta.imagen_producto}" alt="${oferta.Nombre_producto}">
                            <div class="precio-oferta" data-precio="${oferta.Costo}">$${oferta.Costo}</div>
                        </div>
                        <p>${oferta.Descripcion_Producto}</p>
                        <a href="${oferta.link_producto}" class="category-btn">Ir a la Oferta</a>
                        <button class="agregar-carrito">Agregar al Carrito</button>
                        <button class="buscar-alternativa" data-nombre="${oferta.Nombre_producto}">Buscar Alternativa</button>
                    `;
    
                    unimarcContainer.appendChild(ofertaDiv);
                });
    
                // Manejar el evento de agregar al carrito
                manejarEventosAgregarCarrito(unimarcContainer);
                manejarEventosBuscarAlternativa(unimarcContainer);
            })
            .catch(error => console.error('Error en la carga de unimarc:', error));
    
        // Función para manejar el evento de agregar al carrito
        function manejarEventosAgregarCarrito(container) {
            const botonesAgregar = container.querySelectorAll('.agregar-carrito');
    
            botonesAgregar.forEach(boton => {
                boton.addEventListener('click', () => {
                    const ofertaDiv = boton.closest('.producto'); // Selecciona el contenedor del producto
                    const precioDiv = ofertaDiv.querySelector('.precio-oferta'); // Busca el div del precio dentro del contenedor del producto
    
                    if (precioDiv) {
                        const precio = parseFloat(precioDiv.getAttribute('data-precio').trim()); // Asegúrate de que esto sea un número
                        const nombre = ofertaDiv.querySelector('p').textContent; // Obtener el nombre del producto
    
                        if (!isNaN(precio)) { // Verifica que el precio es un número
                            // Agregar o actualizar el producto en el carrito
                            if (!carrito[nombre]) {
                                carrito[nombre] = { precio: precio, cantidad: 1 }; // Agrega el producto con cantidad 1
                            } else {
                                carrito[nombre].cantidad++; // Incrementa la cantidad si ya existe
                            }
                            alert(`${nombre} agregado al carrito. Cantidad: ${carrito[nombre].cantidad}`);
                            updateCart(); // Actualizar el carrito al agregar
                        } else {
                            alert(`Error: El precio no es válido. Valor recibido: ${precioDiv.getAttribute('data-precio')}`);
                        }
                    } else {
                        console.error('No se encontró el div del precio.');
                    }
                });
            });
        }
    
        // Nueva función para manejar el evento de buscar alternativas
        function manejarEventosBuscarAlternativa(container) {
            const botonesBuscar = container.querySelectorAll('.buscar-alternativa');
    
            botonesBuscar.forEach(boton => {
                boton.addEventListener('click', () => {
                    const nombreProducto = boton.getAttribute('data-nombre'); // Obtener el nombre del producto
                    console.log('Nombre del producto:', nombreProducto); // Imprime el nombre para verificar
                    
    
                    fetch(`/buscarAlternativa?nombre=${encodeURIComponent(nombreProducto)}`) // URL de búsqueda
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.alternativa) {
                                showAlternative(data.alternativa); // Mostrar la alternativa
                            } else {
                                alert('No se encontraron alternativas más baratas.');
                            }
                        })
                        .catch(error => console.error('Error al buscar alternativa:', error));
                });
            });
        }
    
        // Función para mostrar la oferta alternativa
        function showAlternative(alternativa) {
            const suggestionContent = document.getElementById('suggestionContent');
            suggestionContent.innerHTML = `
                <h3>Alternativa más barata:</h3>
                <div class="image-container">
                    <img src="${alternativa.imagen_producto}" alt="${alternativa.Nombre_producto}">
                    <div class="precio-oferta" data-precio="${alternativa.Costo}">$${alternativa.Costo}</div>
                </div>
                <p>${alternativa.Descripcion_Producto}</p>
                <a href="${alternativa.link_producto}" class="category-btn">Ir a la Oferta</a>
            `;
            document.getElementById('productSuggestion').style.display = 'block'; // Mostrar el popup
        }
    
        // Función para cerrar el popup
        function closePopup() {
            document.getElementById('productSuggestion').style.display = 'none';
        }
    
        // Función para actualizar el carrito
        function updateCart() {
            const cartItems = document.getElementById('cart-items');
            const totalDisplay = document.getElementById('total');
            cartItems.innerHTML = ''; // Limpiar la lista de productos en el carrito
            let total = 0;
    
            Object.keys(carrito).forEach(productName => {
                const item = carrito[productName];
                total += item.precio * item.cantidad; // Calcular el total basado en la cantidad
                const li = document.createElement('li');
                li.textContent = `${productName}: $${item.precio} (Cantidad: ${item.cantidad})`;
    
                // Botón para eliminar el producto del carrito
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Eliminar';
                removeButton.addEventListener('click', () => {
                    delete carrito[productName]; // Elimina el producto del carrito
                    updateCart(); // Actualiza el carrito después de eliminar
                });
                li.appendChild(removeButton);
                cartItems.appendChild(li);
            });
    
            totalDisplay.textContent = total.toFixed(2); // Mostrar total con dos decimales
        }
    
        // Función de búsqueda (simulada)
        function realizarBusqueda() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            // Aquí puedes implementar la lógica de búsqueda si es necesario
            alert(`Buscando: ${query}`);
        }
    </script>
    
    
</body>
</html>
